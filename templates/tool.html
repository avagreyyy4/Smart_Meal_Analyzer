{% extends 'base.html' %}
{% block title %}Meal Tool{% endblock %}
{% block content %}
<div style="display:flex; gap:2em;">
  <!-- LEFT: Meal Tool Builder -->
  <div style="flex:2;">
    <h1>Meal Builder</h1>
    <form method="post" id="add-form">
    <input type="hidden" name="action" value="add">
    <label for="query">Search Foods:</label>

    <div style="display: flex; align-items: baseline; gap: 4px !important; margin-bottom: 1.5em; width: 100%; max-width: 600px !important;">
      
      <!-- SEARCH INPUT -->
      <div style="flex: 1; position: relative;">
        <input type="text" id="query" class="food-search" autocomplete="off" required
               style="width: 100% !important; max-width: 450px !important;">
        <ul id="custom-suggestions" style="
          position: absolute;
          background: white;
          border: 1px solid #ccc;
          z-index: 10;
          max-height: 300px;
          overflow-y: auto;
          width: 100% !important;
          display: none;
          list-style: none;
          padding: 0;
          margin-top: 4px;
          border-radius: 6px;
        "></ul>
      </div>
    
      <!-- GRAMS INPUT -->
      <div style="position: relative; flex-shrink: 0; margin-left: -3px !important;">
          <input
            type="number"
            name="grams"
            value="100"
            min="1"
            required
            style="
              width: 30px !important;
              padding-right: 1.2em !important;
              padding-left: 0.3em !important;
              font-size: 0.9rem !important;
              direction: ltr !important;
              appearance: textfield !important;
            "
          >
        <span style="
          position: absolute !important;
          right: 17px !important;
          top: 50% !important;
          transform: translateY(-50%) !important;
          font-size: 0.9rem !important;
          color: #aaa !important;
          pointer-events: none;
        ">g</span>
      </div>
    
      <!-- ADD BUTTON -->
      <button type="submit" style="margin-left: 0 !important;">Add</button>
    
    </div>
    <input type="hidden" name="fdc_id" id="fdc_id">
    <input type="hidden" name="food_name" id="food_name">
    <p id="thinking-msg" style="display:none; color: gray; font-style: italic; margin-top: 0.5em;">
  Thinking...
    </p>
    {% if nutrient_warning %}
    <p id="nutrient-warning" style="color:#f87171; margin-top:0.5em;">{{ nutrient_warning }}</p>
    {% endif %}
  </form>

    {% if meal_list %}
    <h2>Your Meal</h2>
    <ul id="meal-list">
    {% for item in meal_list %}
      <li>
        {{ item.name }} - {{ item.calories }} kcal, {{ item.protein }}g protein, {{ item.carbs }}g carbs, {{ item.fat }}g fat, {{ item.sugar }}g sugar
        <form method="post" class="remove-item-form" style="display:inline">
          <input type="hidden" name="action" value="remove">
          <input type="hidden" name="index" value="{{ loop.index0 }}">
          <button type="submit">Remove</button>
        </form>
      </li>
    {% endfor %}
    </ul>

    <h3>Totals</h3>
    <table>
      <thead>
        <tr>
          <th>Calories</th>
          <th>Protein</th>
          <th>Carbs</th>
          <th>Fat</th>
          <th>Sugar</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="total-calories">{{ total.calories }}</td>
          <td id="total-protein">{{ total.protein }}</td>
          <td id="total-carbs">{{ total.carbs }}</td>
          <td id="total-fat">{{ total.fat }}</td>
          <td id="total-sugar">{{ total.sugar }}</td>
        </tr>
      </tbody>
    </table>

    {% if warnings %}
    <div class="alert alert-warning">
      <h3>Nutritional Warnings</h3>
      <ul>
      {% for w in warnings %}
        <li>{{ w }}</li>
      {% endfor %}
      </ul>
    </div>
    {% endif %}

    <form method="post" id="complete-form">
      <input type="hidden" name="action" value="complete">
        
      <button type="submit">This is my complete meal</button>
    </form>
    {% endif %}
      
    <div id="thinking">Thinking...</div>
      
{% if advice %}
  <div class="ai-response-box">
    {% for line in advice.split('\n') %}
      {% if line.strip() %}
        {% if loop.first %}
          <p><strong>{{ line }}</strong></p>
        {% else %}
          <p>{{ line }}</p>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
{% endif %}
      
  </div>

  <!-- RIGHT: Reference Table -->
  <div style="flex:1;">
    <h4>Serving Size Reference (Typical Per-Person Amounts)</h4>
    <table border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr><th>Food Type</th><th>Typical Serving</th><th>Approx. Grams</th></tr>
      </thead>
      <tbody>
        <tr><td>Fruit (whole)</td><td>1 medium apple, banana</td><td>150 g</td></tr>
        <tr><td>Berries</td><td>1 cup</td><td>125 g</td></tr>
        <tr><td>Leafy Greens (raw)</td><td>1 cup</td><td>30 g</td></tr>
        <tr><td>Leafy Greens (cooked)</td><td>½ cup</td><td>90 g</td></tr>
        <tr><td>Vegetables (raw)</td><td>½ cup</td><td>70 g</td></tr>
        <tr><td>Vegetables (cooked)</td><td>½ cup</td><td>85 g</td></tr>
        <tr><td>Rice (cooked)</td><td>½ cup</td><td>125 g</td></tr>
        <tr><td>Rice (dry)</td><td>¼ cup</td><td>45 g</td></tr>
        <tr><td>Pasta (cooked)</td><td>½ cup</td><td>120 g</td></tr>
        <tr><td>Pasta (dry)</td><td>¼ cup</td><td>50 g</td></tr>
        <tr><td>Bread</td><td>1 slice</td><td>30 g</td></tr>
        <tr><td>Tortilla (medium)</td><td>1 piece</td><td>40–60 g</td></tr>
        <tr><td>Cheese</td><td>1 slice / 1 oz cube</td><td>28 g</td></tr>
        <tr><td>Milk / Yogurt</td><td>1 cup</td><td>240 g</td></tr>
        <tr><td>Canned Beans</td><td>½ cup (drained)</td><td>130 g</td></tr>
        <tr><td>Meat / Fish (raw)</td><td>Palm-sized piece</td><td>120 g</td></tr>
        <tr><td>Meat / Fish (cooked)</td><td>Deck-of-cards size</td><td>85 g</td></tr>
        <tr><td>Tofu</td><td>½ cup</td><td>126 g</td></tr>
        <tr><td>Eggs</td><td>1 large</td><td>50 g</td></tr>
        <tr><td>Nuts</td><td>Small handful</td><td>28 g</td></tr>
        <tr><td>Nut Butter</td><td>1 tbsp</td><td>16 g</td></tr>
        <tr><td>Condiments (e.g. ketchup)</td><td>1 tbsp</td><td>15 g</td></tr>
        <tr><td>Oils / Butter</td><td>1 tbsp</td><td>14 g</td></tr>
        <tr><td>Soda / Juice</td><td>1 can (12 oz)</td><td>355 g</td></tr>
        <tr><td>Candy</td><td>1 bar / 10-20 pieces</td><td>45 g / 8-16 g</td></tr>
        <tr><td>Cake / Pie</td><td>1 slice</td><td>100-150 g</td></tr>
        <tr><td>Pancake / Waffle</td><td>1 Pancake / 1 Waffle</td><td>30-100 g</td></tr>
      </tbody>
    </table>
  </div>
</div>
<hr>
<p style="text-align:center;font-size:0.8em;">2025 Smart Meal Helper</p>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='search.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const completeForm = document.getElementById('complete-form');
    const thinkingDiv = document.getElementById('thinking');

    if (completeForm && thinkingDiv) {
      completeForm.addEventListener('submit', function () {
        thinkingDiv.style.display = 'block';
      });
    }
  });
</script>
{% endblock %}